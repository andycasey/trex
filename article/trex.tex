
\documentclass[twocolumn]{aastex62}

\usepackage{bm}
\usepackage{amsmath}
\usepackage{color}
\usepackage{comment}
\usepackage{minted}


\received{\today}
\revised{\today}
\accepted{\today}

% scaffolding
\newcommand{\todo}[1]{\textcolor{red}{#1}}

% stellar things
\newcommand\teff{T_{\rm eff}}
\newcommand\logg{\log{g}}
\newcommand\feh{[\rm{Fe}/\rm{H}]}
\newcommand\mh{[\rm{M}/\rm{H}]}
\newcommand{\luminosity}{L_\circ}
\newcommand{\radius}{R_\circ}

% maaaaath 
\newcommand{\vect}[1]{\boldsymbol{\mathbf{#1}}}
\renewcommand{\vec}[1]{\vect{#1}}
\newcommand{\likelihood}{\mathcal{L}}
\newcommand{\given}{|}


% projects
\newcommand{\project}[1]{\textsl{#1}}
\newcommand{\package}[1]{\texttt{#1}}
\newcommand{\acronym}[1]{{\small{#1}}}
\newcommand{\ESA}{\acronym{ESA}}
\newcommand{\Gaia}{\project{Gaia}}
\newcommand{\gaia}{\project{gaia}}
\newcommand{\rp}{\textsl{rp}}
\newcommand{\bp}{\textsl{bp}}

% definitions
\newcommand{\GaiaRVE}{\sigma_{\mathrm{V}_\mathrm{R}}^\mathrm{MTA}}
%\newcommand{\RVJitter}{\sigma(\mathrm{V}_\mathrm{R}^{t})}
\newcommand{\RVJitter}{j_{rv}}
\newcommand{\AstJitter}{j_{a}}

% for version control
\newcommand{\vcpath}{vc.tex}

\IfFileExists{\vcpath}{\input{\vcpath}}{
	\newcommand{\giturl}{UNKNOWN}
	\newcommand{\gitslug}{UNKNOWN}
	\newcommand{\githash}{UNKNOWN}
	\newcommand{\gitdate}{UNKNOWN}
	\newcommand{\gitauthor}{UNKNOWN}
	\newcommand{\watermarktext}{DRAFT}
}

\submitjournal{AAS}

\shorttitle{Stellar multiplicity}
\shortauthors{Casey et al.}

\begin{document}

\title{Stellar multiplicity in \Gaia}

\correspondingauthor{Andrew R. Casey}
\email{andrew.casey@monash.edu}


\author[0000-0003-0174-0564]{Andrew R. Casey}
\affiliation{School of Physics \& Astronomy, 
			 Monash University,
			 Wellington Rd, Clayton 3800, Victoria, Australia}
\affiliation{Faculty of Information Technology, 
			 Monash University, 
			 Wellington Rd, Clayton 3800, Victoria, Australia}

\author[0000-0002-9328-5652]{Daniel Foreman-Mackey}
\affiliation{Flatiron Institute, 
			 162 Fifth Ave, New York, NY 10010, USA}

\author[0000-0003-3494-343X]{Carles Badenes}
\affiliation{Department of Physics and Astronomy, 
			 University of Pittsburgh, 
			 3941 O'Hara Street, Pittsburgh, PA 15260, USA}

\author{Adrian Price-Whelan}

% Others to thank and/or invite to contribute:
% David Hogg
% Hans-Walter Rix
% Kareem El-Badry
% Daniel Michalik
% Rosemary Mardling

% other Sprinters?

\begin{abstract}
Stellar multiplicity underpins much of astrophysics. Point sources are frequently
assumed to be single stars because unresolved companions are challenging to detect
and characterize. Here we develop a model to self-calibrate the radial and astrometric 
jitter (noise) in the second \Gaia\ data release. We estimate the Bayes factor 
that a source is a single star given the astrometric and radial jitter.
We reliably detect and partially characterize $\sim 10^6$ stellar multiples, including
astrometric binaries up to 2\,kpc, as well as spectroscopic binaries (SB2) with orbital 
periods $P \lesssim$ 1,300\,days and semi-amplitudes $K \gtrsim 1\,\textrm{km\,s}^{-1}$. 
We estimate radial velocity semi-amplitudes for SB2 systems.

% Simulations showing what we can detect.

% Multiplicity fraction

% Stellar multiplicity and metallicity

% Superlative systems: those with non- or sub-luminous companions.
\end{abstract}

%\keywords{editorials, notices --- 
%miscellaneous --- catalogs --- surveys}
\section{Introduction} \label{sec:intro}

\todo{Background literature on stellar multiplicity.}

\vspace{0.5em}

In this work we make use of astrometry (including radial motion)
from the second \Gaia\ data release to infer the presence of stellar companions 
for millions of point sources.
We provide partial characterisations of these systems,
based on the data available for each source. In Section \ref{sec:method} we 
describe our methods, and in Section \ref{sec:results} we outline our results 
in context of other stellar multiplicity surveys. We include comparisons of 
binary properties between clusters and the field, as a function of stellar 
properties (e.g., stellar metallicity), and highlight some particularly 
noteworthy systems that would benefit from additional observations. 


\clearpage

\section{Methods} \label{sec:methods}


Stellar multiplicity can be inferred from \Gaia\ data using radial velocity
measurements, astrometry, and/or photometry. These data are sensitive to
stellar multiplicity in different ways. In the following sub-section we 
describe our methods for detecting stellar multiplicity from astrometric 
jitter, before describing
how our methods vary for radial velocities.\footnote{Throughout this work when we use
the term \emph{jitter} we are referring to the intrinsic uncertainty in measuring
either the astrometric position or the radial velocity.}
We do not make use of photometry
for identifying stellar multiples, despite the clear population of 
main-sequence binaries present in the \Gaia\ data \citep{someone}.
In later sections we show that these binary systems are identifiable by their
jitter in astrometry and/or radial velocity.



\subsection{Astrometry} \label{sec:methods/astrometry}

We restrict our work to the brightest 16,676,756 sources in \Gaia\ DR2 
\citep{Lindegren:2018}. \Gaia\ estimates the astrometric position of each
source by measuring the photocenter in the G-band. If the source is a 
binary system with a mass ratio $q \neq 1$ then the photocenter changes as 
a function of the orbital parameters, as well as the system's parallax and
proper motion.\footnote{The photocenter remains constant for binary systems
of equal mass and luminosities.} This uncertainty in astrometric position
remains after accounting for the parallax and proper motion. 

There are many sources of astrometric jitter for a given source, but here 
we will assume that the principal source of excess jitter is the presence of a
companion. We take the reduced unit weight error (RUWE) as a measure of
astrometric jitter
\begin{eqnarray}
	\AstJitter = \sqrt{\frac{\chi^2_{al}}{N_{obs,al} - 5}} \label{eq:astrometric_unit_weight_error}
\end{eqnarray}
\noindent{}where 
$\chi^2_{al}$ is the astrometric $\chi^2$ value in the along-scan 
direction (column \texttt{astrometric\_chi2\_al}) and $N_{obs,al}$ is the number of astrometric observations in the along-scan
direction (column \texttt{astrometric\_n\_obs\_al}). 
The RUWE is unaffected by the `degree of freedom bug'
that occurred during the processing of the the second \Gaia\ data release
\citep[e.g., see Appendix A1 of ][]{Lindegren:2018}, which resulted in 80\% of
sources having zero astrometric excess noise. 
The RUWE can be interpreted similarly to how the
astrometric excess noise would be interpreted in that large values are less
consistent with a single star model, but this must be considered in context with
sources of similar colours, apparent G-band magnitudes, and to a lesser extent, 
absolute G-band magnitudes. 

For these reasons we will assume that for a sample of sources of similar
	\bp\ - \rp\ colour,
	apparent G-band magnitude, and
	absolute G-band magnitude,
the distribution of astrometric jitter is a mixture of two components:
\begin{enumerate}
\item \emph{single-star systems}, where the jitter represents the minimum uncertainty
	   with which \Gaia\ can measure the astrometric position for a source with those 
	   properties, and
      
\item \emph{stellar multiples}, where the jitter is significantly higher 
	  than what is measured for single-star systems of similar properties.
\end{enumerate}

The component of stellar multiples will contain binary systems, trinaries, and other
higher-order multiples. For practical purposes here we will assume that all stellar
multiples are binary systems and use the terms interchangeably.

We can expect that single stars should have a RUWE near 1 because it is a reduced 
$\chi^2$ distribution, but the expectation and variance of the RUWE will vary as a
function of colour and magnitude. However, we cannot \emph{a priori} write down a 
relationship to describe how the expectation and variance will behave given some
source properties because it is a complex function of unknown systematics. For these
reasons we adopt a non-parametric model for the astrometric jitter for single stars.

Consider a \Gaia\ source of interest. For this source we randomly draw at least 128 
sources (up to 1,024) that have a similar \bp\ - \rp\ colour (within 0.05 mags),
apparent G-band magnitude (within 0.5 mags) and absolute G-band magnitude (within 0.5 mags).
We assume that any single stars within this `ball' of parameter space should have 
comparable astrometric jitter. We also assume that the randomly selected sample 
contains \emph{some} single stars, and \emph{some} stellar multiples. Right now we
do not care which is which. Here we are most interested in estimating the expected
jitter for single stars, and to do so we need to know what the jitter looks like for
binary stars \emph{and} single stars otherwise we would under-estimate the typical
astrometric jitter for single stars.


In Figure~\ref{fig:example-mixture-model} we show that the distribution of astrometric 
jitter for sources similar to a \Gaia\ source of interest. We fit the distribution of
astrometric jitter with a two-component mixture model. The first component is a normal
(Gaussian) distribution, and the second is a log-normal distribution. A log-normal
distribution has sufficient flexibility to fit the entire astrometric jitter, so to
avoid this we fix the mean of the log-normal distribution $\mu_m$ to be 
\begin{eqnarray}
	\mu_m \equiv \ln(\mu_s + 3\sigma_s) + \sigma_m^2
\end{eqnarray}
\noindent{}where $\mu_s$ and $\sigma_s$ is the mean and standard deviation of the normal
component and $\sigma_m$ is the standard deviation of the log-normal distribution. The 
$s$-subscript refers to single stars, $m$ for multiple. Fixing $\mu_m$ like this forces 
the \emph{mode} of the log-normal distribution to be at $\mu_s + 3\sigma_s$, ensuring
that the normal distribution is capturing the astrometric jitter values of single stars
and the log-normal is capturing the extended tail. We experimented with different priors
and model parameterisations and found that fixing $\mu_m$ had little to no effect on
our final inferences. The parameters of this two-component model are therefore
$\vec\theta = \{w,\mu_s,\sigma_s,\sigma_m\}$ where $w$ is the mixing proportion. 
The likelihood is
\begin{eqnarray}
	\mathcal{L} &\propto& \prod_{n=1}^{N} \left[\frac{w}{\sqrt{2\pi\sigma_s}}\exp\left(-\frac{[\AstJitter - \mu_s]^2}{2\sigma_s^2}\right) \right. \nonumber \\
	&& \quad + \left.\frac{1-w}{\AstJitter\sigma_m\sqrt{2\pi}}\exp\left(-\frac{(\ln\AstJitter - \mu_m)^2}{2\sigma_m^2}\right)\right]
\end{eqnarray}
\noindent{}and we adopt uninformative priors on all parameters:
\begin{eqnarray}
	   w & \sim{} & \mathcal{U}\left(0.5, 1\right) \\
   \mu_s & \sim & \mathcal{U}\left(0.5, 5\right) \\
\sigma_s & \sim & \mathcal{U}\left(0.05, 1\right) \\
\sigma_m & \sim & \mathcal{U}\left(0.1, 2\right)
\end{eqnarray}


We optimize the model parameters by minimizing the negative log probability
using the \texttt{L-BFGS-B} optimization algorithm \citep{Broyden:1970,Fletcher:1970,Goldfarb:1970,Shanno:1970,Nocedal:2006}. For each source of interest, this procedure provides us with a
noisy estimate of the expected astrometric jitter for a single star $\mu_s$
and the variance in that jitter $\sigma_s^2$. We could repeat this procedure
for every \Gaia\ source, but each source of interest would be treated independently.
That is to say that there is no constraint that the expected jitter (or its variance)
should vary smoothly with respect to the source parameters. There's also no specific
constraint that two very similar sources should have exactly the same expected jitter
because those two sources could have selected different comparison sources and 
therefore fit slightly different jitter distributions. For these
we repeat the procedure described above for 10,000 \todo{randomly selected} sources
of interest, and fit a Gaussian process to our noisy estimates of $\vec\theta$.



A Gaussian process is specified by the use of kernels that describe the covariance structure
between data points instead of directly modelling the data \citep[see][for a thorough introduction]{Rasmussen:2005}. This can provide a very flexible generative model for the data typically with only very
few hyperparameters. Here we use an exponential-squared kernel 
\begin{eqnarray}
k(\vec{r}^2) = \exp\left(\frac{\vec{r}^2}{2}\right)
\end{eqnarray}
\noindent{}with an unknown white noise component that is added to the diagonal of the
covariance matrix, and an unknown mean value.
\todo{Eqn introducing $\vec{X}$ and $\vec{y}$ for GPs}.
The $\vec{X}$ matrix here has shape $10000 \times 3$:
the \bp\ - \rp\ colour, apparent G band magnitude, and absolute G-band magnitude for the 
10,000 randomly selected points of interest. We allow for different scale lengths ($r$) in
each dimension, and we construct four Gaussian process models: one for each parameter in $\theta$.
We optimized the hyperparameters of each Gaussian process model using \texttt{george} 
\citep{Foreman-Mackey:2015, Ambikasaran:2015}, conditioned on the noisy estimates of
the randomly selected 
sources. With these models we made predictions for the expected jitter terms 
$\hat{\vec{\theta}}$ and their variances for all 16,676,756 \Gaia\ sources used in this work.



With these predictions of astrometric jitter we report the log likelihood of the
single star model and the multiple star model
\begin{eqnarray}
\ln\likelihood_{s,a}\left(\AstJitter\given\hat{\vec{\theta}}\right) &=& \log{\hat{w}} - \frac{\left(\AstJitter - \hat{\mu_s}\right)^2}{2\hat{\sigma_s}^2} - \frac{1}{2}\log{\hat{\sigma_s}}  \\
\ln\likelihood_{m,a}\left(\AstJitter\given\hat{\vec{\theta}}\right) &=& \log{(1-\hat{w})} 
- \frac{\left(\ln\AstJitter - \hat{\mu_m}\right)^2}{2\hat{\sigma_m}^2} - \log{\AstJitter\hat{\sigma_m}} \nonumber \\
\end{eqnarray}
\noindent{}as well as the likelihood ratio $\lambda_{a}$ of being a stellar multiple
relative to being a single star
\begin{eqnarray}
	\lambda_{a} = \frac{\likelihood_{m,a}}{\likelihood_{s,a}}
\end{eqnarray}
\noindent{}and the point estimate of the probability of being a single star given the astrometric jitter $\tau_\textrm{ast}$:
\begin{eqnarray}
	\tau_\textrm{ast} = \frac{p_{s,a}(\AstJitter\given\hat{\vec\theta})}{p_{s,a}(\AstJitter\given\hat{\vec\theta}) + p_{m,a}(\AstJitter\given\hat{\vec\theta})}
\end{eqnarray}
With these point estimates one can select sources that are likely to be stellar
multiples given their astrometric jitter by requiring $\tau_{s,a} \approx 0$ and 
$\lambda_a \gg 1$. The heuristic for considering what is a likely astrometric binary
depends on the situation, but we make recommendations in Section~\ref{sec:discussion}.




\subsection{Radial velocity} \label{sec:methods/rvs}

% TODO: Move to radial velocity section
%For simplicity we will assume that a source is either a single
%star or a \emph{multiple system}. Higher-order stellar multiples are less
%likely than binaries, but here we have no information to distinguish binaries
%from higher-order systems, so we only provide statistics on whether a system
%is consistent with being a single star, or a stellar multiple within a given
%range of orbital parameters. 


Radial velocity measurements are not available for individual epochs in the 
second \Gaia\ data release \citep{Lindegren:2018,Cropper:2018}. However, the
median radial velocity and associated error is available for 7,224,631 sources 
\citep{Cropper:2018}.
The reported radial velocity error ($\GaiaRVE$; column name \texttt{radial\_velocity\_error}) 
is a function of the number of transits $N$ (i.e., the number of observations; 
given by the column \texttt{rv\_nb\_transits}) and the standard deviation of 
those measurements. 
This allows us to calculate the standard deviation in radial 
velocity for each source, independent of the number of measurements,
which we will refer to as the \emph{radial velocity jitter} $\RVJitter$,
\begin{eqnarray}
	\RVJitter = \left[\frac{2N}{\pi}\left(\GaiaRVE\right)^2 - 0.11^2\right]^\frac{1}{2} \quad .
\end{eqnarray}


We assume that the jitter for a single star will change depending on the
source properties. For example, the mean radial velocity jitter of single stars 
with $\teff \approx 6000\,\textrm{K}$ will be higher than the jitter of single stars with
$\teff \approx 5000\,\textrm{K}$, all else being equal. For these reasons, in order to evaluate whether 
a source is more likely to be a single star or a stellar multiple, we must consider 
the jitter in context with other sources that have a similar properties (\bp\ - \rp\ colour,
apparent magnitude, and absolute magnitude).


For a single star, or a star without a significant mass companion, the source radial
velocity jitter represents the minimum uncertainty with which \Gaia\ can measure 
radial velocity for a star of that colour, apparent magnitude, and absolute magnitude.
Stars with bluer colours have fewer absorption lines with deeper wings, 
and fainter stars have on average lower signal-to-noise (S/N) ratios, both of which result in noisier radial
velocity measurements. The absolute magnitude is similarly important, as giant stars have narrow absorption lines than main-sequence stars of the same temperature and colour. When the source is an unresolved spectroscopic binary (SB2) the radial velocity
jitter is a contribution of the expected jitter for the more luminous star
(if it were a single star) and the contribution of the radial velocity semi-amplitude of the binary. Specifically, given noiseless estimates of the radial velocity over at least one orbital period, the standard deviation of the radial velocity is related
to the radial velocity semi-amplitude by $\sqrt{2}$ (Appendix~\ref{app:prove-K}).
In Section~\ref{sec:methods} we define our estimate of the radial velocity
semi-amplitude and its error (equations \ref{eq:X} and \ref{eq:Y}) -- here we simply introduce the concept that significant excess radial velocity jitter is
informative about the radial velocity semi-amplitude.



Some sources in \Gaia\ DR2 do not have reported radial velocities even though they are
apparently bright enough and within a suitable \bp\ - \rp\ colour range. The two most
likely explanations are that either the \Gaia\ team identified the source to be a
double-lined spectroscopic binary, or the radial velocity error $\sigma_{\textrm{V}_\textrm{R}}^\textrm{MTA}$ exceeded 20\,km\,s$^{-1}$ (irrespective of the number of transits),
and so the source radial velocity was removed \citep[see Section XX of ][]{Cropper:2018}. 
If the number of transits is large then we can still identify binary
systems with radial velocity semi-amplitudes exceeding 20\,km\,s$^{-1}$, but
we cannot use the \emph{lack} of a reported radial velocity as a reliable
indicator of stellar multiplicity. This is illustrated in Appendix~\ref{app:missing-rvs}, where we show that an absence of radial
velocity is a combination of sky completeness, the initial \Gaia\ source
catalog, as well as stellar multiplicity. For these reasons, if a \Gaia\
source does not have a radial velocity error then we only use the astrometric
jitter to inform us about stellar multiplicity.


\todo{Estimates of uncertainty on $\tau$. Where in parameter space do we lose sensitivity on $\tau$? And while we have the readers' attention, some brief cautionary notes on using  $\tau$.}





\todo{Figure: showing K as a function of stellar parameters}





\begin{figure*}
%	%\includegraphics[width=\textwidth]{../figures/todo.png}
%	%\includegraphics[width=\textwidth]{figures/tau_single_hrd.png}
    \caption{Two-dimensional histogram of \todo{X} showing the mean single star probability $\tau$ per bin. The three panels show probabilities calculated from different sources of information: (a) using only radial velocity jitter; (b) using only astrometric jitter; and (c) using the joint information of radial velocity and astrometric jitter. All panels share the same colour range.}
    \label{fig:tau_single_hrd_v5}
\end{figure*}



%For higher-order star systems with longer periods, we can still find that a
%stellar multiple system is more likely than a single star scenario, but our
%estimate of the orbital properties (e.g., the semi-amplitude $K$) will be biased
%to lower values because we have not fully sampled half of the orbital period.
%At even longer orbital periods, or for stellar multiples with mass ratios that
%produce a small velocity semi-amplitude $K$, under our assumptions these systems 
%may be classified as single-star systems because the intrinsic radial velocity variation is within the expected 
%variations for single stars of a similar apparent magnitude and colour. We 
%revisit this issue in Section \ref{sec:sb_limits}, where we explicitly define 
%the probability that a \Gaia\ source is a SB1-type system $p(\textrm{SB1}|y)$ 
%within defined limits of orbital period (and other orbital and source parameters). 
%Outside of this parameter range, we are insensitive to distinguishing single-star 
%systems from higher-order SB1-type systems.





%\subsection{Unresolved near-equal mass binaries: photometry}
%\label{sec:pb_methods}

%If a binary system is observed nearly face-on (at an inclination angle 
%$i \approx 0^\circ$) then there is will be no detectable excess radial 
%velocity variations. In principle there may be detectable astrometric
%variations, but most near-equal mass binaries would be detected more 
%reliably through intrinsic magnitudes that are anomalously lower (brighter)
%and bluer colours than what would be expected for a single star system.




\begin{figure}
	\centering
%	%\includegraphics[width=0.35\textwidth]{../figures/sb2_histograms.pdf}
%	%\includegraphics[width=0.4\textwidth]{../figures/todo.png}
    \caption{Distribution of 
    			(a) astrometric unit weight error (see Eq. \ref{eq:astrometric_unit_weight_error}),
			%$u = \left(\chi_{al}^2/(N_{al} - 5)\right)^{1/2}$
			%		where $\chi_{al}^2$ and $N_{al}$ is the astrometric goodness-of-fit and number 
			%		of observations in the along-scan direction, respectively (columns 
			%			\texttt{astrometric\_chi2\_al} and \texttt{astrometric\_n\_obs\_al}), 
				(b) photometric \bp\ - \rp\ excess factor, 				
	 				and 
				(c) photometric \rp\ variability (see Eq. \ref{eq:photometric_variability})
			of sources that lack radial velocities but their properties suggest they should have
			a radial velocity measurement (red; candidate SB2 systems), and an equal-size control sample of sources
			with similar \bp\ - \rp\ colours, apparent magnitudes, absolute magnitudes,
			which \emph{do} have radial velocity measurements (grey). It is clear that the
			candidate SB2 systems have systematically higher astrometric unit weight error
			than the control sample, and a larger variance in photometric \bp\ - \rp\ excess
			factor and photometric variability, both consistent with a secondary source.}
    \label{fig:sb2_histograms}
\end{figure}




\section{Results} \label{sec:results}



We confirm that most stars are in binaries or higher order multiples.
A cross-match of our catalog with the ninth spectroscopic binary catalog
\citep{SB9} reveals that we confidently detect SB1-type binary systems (from
radial velocity variations) with semi-amplitudes down to $K \approx \todo{X}\,\textrm{km\,s}^{-1}$ and orbital
periods as long as about 44\,months ($\approx3.5$\,yr) -- twice the observing span
of the second \Gaia\ data release. Both of these bounds are expected: at low $K$ \Gaia\
lacks the radial velocity precision to distinguish single stars from stellar multiples,
and only about half the orbital period is required to measure the peak-to-peak radial velocity variations.
If the orbital period is longer, we can still reliably identify some systems as stellar
multiples if the radial velocity semi-amplitude is large enough, but in these instances we will
systematically underestimate the true radial velocity semi-amplitude because \Gaia\ has not
observed at least half the orbital period and we do not have access to the radial velocity
measurements at each epoch to fit a Keplerian curve. In other words, we implicitly assume
that \Gaia\ has observed at least half the orbital period for every binary system we detect.
If this assumption is not met, our radial velocity semi-amplitude estimates will be underestimated
by about the same fraction of the observing span relative to half the true orbital period.

We accurately estimate the radial velocity semi-amplitude for well-studied SB1-type systems
with periods $P < 44\,\textrm{months}$ (Figure \ref{fig:rv-sb9-comparison}. \todo{Our estimated
errors on $K$ also appear reasonably consistent given more precise literature estimates.}
The estimates of $K$ and their associated errors could be improved by considering the exact
moments when \Gaia\ observed each source -- even if the actual measurement at each epoch is
not known -- but we consider that to be a useful extension of this work. \todo{In Figure \ref{fig:rv-p-k}
we show the orbital periods and radial velocity semi-amplitudes where we confidently detect binary
systems.}


\todo{Comparison with APW unimodal; APW first percentile}

\todo{Comparison with astrometric binaries detected -- are there any catalogs of these?}

\todo{Comparison with Badenes, Troup}

\todo{Comparison with Ragahvan, who had many different detection methods}

\subsection{Stellar multiplicity across the Hertszprung-Russell diagram}

\subsection{Recoverability}
We derive a function to evaluate the probability that we would have detected
a source as a binary system -- and how we might have partially characterised that
system -- given the properties of the stars in the binary system, their orbital parameters,
and the resulting source properties observed by \Gaia.  This function can be used
to evaluate systematics in our detection method, but it is only approximate \todo{because
of \Gaia\ ssytematics, scanning pattern, etc}.

\todo{What do we need: the RV jitter and astrometric jitter produced, given the properties of the stars and how far away the system is.}


\todo{Do that. Make plots.}

\todo{Number of binaries detected as a function of things}

\todo{The imprint from the IGSC and the scanning pattern}


\subsection{The stellar multiplicity fraction}

\todo{Binary fraction as a function of everything}



\section{Discussion} \label{sec:discussion}

\begin{itemize}
	\item \todo{Binary fraction in the spaces that we were fitting: rp flux, colour, etc, just showing the transition of  probabilities}
	\item \todo{Binary fraction as a function of fitting properties (e.g., colour, absolute RP mag, apparent RP mag)}
	\item \todo{Binarity across the H-R diagram}
	\item \todo{What are the distributions of orbital parameters of binary systems that we would be able to detect?}
\end{itemize}

\begin{itemize}
	\item \todo{Binarity with metallicity }
    \item \todo{binarity in clusters vs the field?}
    \item \todo{binarity among extremely metal-poor stars?}
\end{itemize}


\acknowledgements

% At least some of these people will be promoted to the author list.
It is a pleasure to thank
	Berry Holl (Observatoire de Gen\'eve),
	Jose Hernandez (ESAC),
	Daniel Michalik (ESA/ESTEC),
	Kevin C. Schlaufman (Johns Hopkins University),
	Lorenzo Spina (Monash University),
		and
	Sergey Koposov (Carnegie Mellon University).
This work was supported in part by the Australian Research Council 
through Discovery Grant DP160100637.
This work has made use of data from the European Space Agency (ESA) mission {\it
Gaia} (\url{https://www.cosmos.esa.int/gaia}), processed by the {\it Gaia} Data
Processing and Analysis Consortium (DPAC,
\url{https://www.cosmos.esa.int/web/gaia/dpac/consortium}). Funding for the DPAC
has been provided by national institutions, in particular the institutions
participating in the {\it Gaia} Multilateral Agreement.  This research was
developed in part at the NYC Gaia DR2 Workshop at the Center for Computational
Astrophysics of the Flatiron Institute in 2018 April.

This work has made use of CosmoHub. CosmoHub has been developed by the Port 
d'Informaci\'o Cient\'ifica (PIC), maintained through a collaboration of the 
Institut de F\'isica d'Altes Energies (IFAE) and the Centro de Investigaciones 
Energ\'eticas, Medioambientales y Tecnol\'ogicas (CIEMAT), and was partially 
funded by the ``Plan Estatal de Investigaci\'on Científica y T\'ecnica y de 
Innovaci\'on'' program of the Spanish government.


\appendix
\section{Reproducibility}
This project was developed in a \texttt{git} repository hosted at \giturl. 
The repository includes notebooks that demonstrate the progression our work,  
\LaTeX\ to compile this manuscript, and scripts to reproduce the analysis described
in this manuscript. 
We executed the following
Astronomical Data Query Language (\texttt{ADQL})\footnote{http://www.ivoa.net/documents/latest/ADQL.html} 
query through CosmoHub \citep{Carretero:2017} to retrieve the \Gaia\ data:
\begin{minted}[style=friendly]{postgresql}
 SELECT *
   FROM gaiadr2.gaia_source
  WHERE phot_g_mean_mag <= 14
\end{minted}

The results presented here can be reproduced in full (including data
retrieval, analysis, creation of figures, and manuscript compilation) using these
commands in a modern terminal:
% this is not python, but latex fails to evaluate \githash if I set bash environment.
\begin{minted}[
style=friendly,
escapeinside=||
]{python} 
git clone https://github.com/andycasey/velociraptor.git velociraptor
cd velociraptor
git checkout |\githash|
./reproduce
\end{minted}

Reproducing these results will require at least \todo{X}\,Gb of free disk space 
and \todo{Y}\,hours of compute time. The settings in the \texttt{model.yml} file
can be adjusted to reduce the sample size of the data and shorten the compute 
time at the expense of accuracy. 

\section{Radial velocity completeness as a function of \Gaia\ source properties} \label{sec:appendix-missing-rvs}



\subsection{SB2 Systems: Double-lined spectroscopic binaries}
\label{sec:sb2_methods}

Many sources in the second \Gaia\ data release do not have a reported radial 
velocity, despite being bright enough ($G \lesssim 13$) and in a suitable 
temperature range (e.g., between $\approx4000\,\textrm{K}$ and $\approx6500\,\textrm{K}$) 
for radial velocities to be measured \citep{Cropper:2018}. One reason 
why radial velocity measurements are \emph{not} reported for these stars is 
because the \Gaia/DPAC team have may identified the source to be a double-lined 
spectroscopic binary (a so-called SB2-type system), either through a 
composition of two stellar sources present in the spectra, or from multiple 
(significant) modes in the cross-correlation function. In these situations it
is not sensible to report a point estimate of the radial velocity of the point 
source. For fainter or bluer sources, however, the radial velocity 
may not be reported simply because it is too faint, blue, or red. 


We calculated the completeness of radial velocity measurements (e.g., the
fraction of sources with reported radial velocities) as a function of all 
available source properties that might affect whether the radial velocity may
be reported or not. This included position ($\alpha$, $\delta$, $l$, $b$),
parallax, proper motions, apparent magnitudes, \bp\ - \rp\ colour, 
properties of the radial velocity templates, stellar parameters ($\teff$, $\radius$, $\luminosity$),
and other properties. 


In Figure \ref{fig:radial_velocity_completeness} we show the completeness as 
a function of some pertinent properties, which demonstrate that the radial 
velocity completeness is relatively flat until a source becomes too faint 
(low \rp\ flux), or is either too blue or too red. We adopt conservative 
limits for when the radial velocity completeness starts to drop with these 
properties, and we assume that any source within the following range of 
source parameters
\begin{eqnarray}
	\todo{bounds}
    \label{eq:sb2_criteria}
\end{eqnarray}
\noindent{}is likely to be a double-lined spectroscopic binary (SB2) if no 
radial velocity is reported. That is to say that we are explicitly assuming
that if a point source meets the criteria in Equation \ref{eq:sb2_criteria} 
and does not have a reported radial velocity measurement, then the point 
source is an unresolved double-lined spectroscopic binary. In principle we 
could make more realistic attempts to model the radial velocity completeness as
a function of stellar properties rather than simply stating ``sources within
this parameter range should have radial velocities unless they are SB2 systems'',
but the radial velocity completeness within our specified range is reasonably
flat.





\begin{figure*}
%	%\includegraphics[width=1.0\textwidth]{../figures/sb2_rvs_completeness.pdf}
%	%\includegraphics[width=1.0\textwidth]{../figures/todo.png}
    \caption{Fraction of \Gaia\ sources with reported radial velocities
		     as a function of source properties. Within the adopted source
		     parameter ranges (gray; see Section \ref{sec:sb2_methods})
		     the radial velocity completeness is approximately flat.
		     We flag sources within this range that do not have reported 
		     radial velocities to be candidate SB2 systems.}
    \label{fig:sb2_rvs_completeness}
\end{figure*}




\begin{figure*}
%	%\includegraphics[width=1.0\textwidth]{../figures/sb2_sky_structure.pdf}
%	%\includegraphics[width=1.0\textwidth]{../figures/todo.png}

    \caption{Fraction of sources (per sky bin) without reported radial velocities
    		 for all sources with $G \lesssim 13$ (top) and sources in the ranges
		 	 specified by Eqs \ref{eq:sb2_ranges} (bottom), where we assert that a missing
			 radial velocity measurement signifies a likely SB2 candidate . The color scale is 
			 arbitrarily set to highlight structure, where black indicates a higher
			 fraction of sources do not have reported radial velocities. Crowding
			 in the galactic plane likely results in some sources not having radial
			 velocities reported. The large scale structure visible in both axes is
			 a combined effect of the initial \Gaia\ source list, the scanning law,
			 and star forming regions (i.e., where emission in the \ion{Ca}{2} 
			 triplet likely causes issues for radial velocity determination).}
    \label{fig:sb2_sky_structure}
\end{figure*}




\software{
	\package{Astropy} \citep{astropy:v1,astropy:v2},
    \package{IPython} \citep{ipython},
    \package{matplotlib} \citep{mpl},
    \package{numpy} \citep{numpy},
    \package{scipy} \citep{scipy},
    \package{Stan} \citep{stan},
    \package{CosmoHub} \citep{cosmohub},
    \package{TensorFlow} \citep{tensorflow}
    \package{Jupyter Notebooks} \citep{jupyter-notebooks}
}    


\appendix

\section{Proof of $\RVJitter = K\sqrt{2}$ for circular orbits}

Consider a binary system on a circular orbit. The radial velocity of the system at any time $t$ is given by
\begin{equation}
	v_r(t) = \gamma + K\sin\left(\frac{2\pi}{P}t + \varphi_0\right)
\end{equation}
\noindent{}where $\gamma$ is the systemic radial velocity, $P$ is the orbital period, $\varphi_0$ is the phase of the initial observation at $t_0$, and $K$ is the radial velocity semi-amplitude. Let $\omega = \frac{2\pi}{P}$. If the observed baseline $T > \frac{P}{2}$ and $t \sim \mathcal{U}\left(0,T\right)$ then we can ignore the initial phase $\varphi_0$ and calculate the R.M.S. of radial velocities over that baseline as 
\begin{eqnarray}
v_\mathrm{rms}^2 &=& \frac{1}{T}\int_{0}^{T}\left[v_r(t)\right]^2 \partial{}t \\
v_\mathrm{rms}^2 &=& \frac{1}{T}\int_{0}^{T}\left[\gamma + K\sin(\omega{}t)\right]^2\partial{}t\\
v_\mathrm{rms}^2 &=& \frac{1}{T}\int_{0}^{T}\left[\gamma^2 + 2K\gamma\sin\left(\omega{}t\right) + K^2\sin^2\left(\omega{}t\right)\right] \partial{}t
% By making use of the double-angle formulae
%v_\mathrm{rms}^2 &=& \frac{1}{T}\left[\gamma^2{t}|_0^{T} + \frac{2K\gamma}{\omega}\cos{\left(\omega{}t\right)}|_0^T + \frac{K^2}{2}\int_0^T\left(1 - \cos\left(2\omega{}t\right)\right)\partial{}t\right]
\end{eqnarray}
After expanding terms and using the identity
\begin{equation}
	\sin^2\left(\omega{}t\right) = \frac{1}{2}\left[1 - \cos\left(2\omega{}t\right)\right]
\end{equation}
\noindent{}we find
\begin{eqnarray}
v_\mathrm{rms}^2 &=& \frac{1}{T}\left[\gamma^2{t} + \frac{2K\gamma}{\omega}\cos{\left(\omega{}t\right)} + \frac{K^2t}{2} - \frac{K^2}{4\omega}\sin\left(2\omega{}t\right) \right]_0^{T}\\
v_\mathrm{rms}^2 &=& \frac{1}{T}\left[\gamma^2T + \frac{2K\gamma}{\omega}\left(\cos\left(\omega{}T\right)-\cos\left(0\right)\right) + \frac{K^2T}{2}-\frac{K^2}{4\gamma}\left(\sin\left(2\omega{}T\right) - \sin\left(0\right)\right)\right] \\
%v_\mathrm{rms}^2 &=& \frac{1}{T}\left[\gamma^2T+\frac{2K\gamma}{\omega}\right]
%v_\mathrm{rms}^2 &=& \frac{1}{T}\left[\gamma^2T - \frac{2K\gamma}{\omega} + \frac{TK^2}{2} - \frac{K^2}{4\gamma}\right]
\end{eqnarray}

\todo{Check eqn set above}

If we assume that each radial velocity measurement has some associated noise, and that noise is
homoskedastic, then an unbiased estimate of the radial velocity semi-amplitude is given by
\begin{equation}
	K = \todo{todo}
\end{equation}
\noindent{}and the error on that estimate is
\begin{equation}
	\sigma_{K} = \todo{todo} \quad .
\end{equation}

\todo{Prove that it is an unbiased estimator}.


\bibliography{trex}{}
\bibliographystyle{aasjournal}

%\listofchanges

\end{document}
